#!/bin/bash
# Claude Code Account Switcher
# Usage: cc [args...]    - launches claude with account picker
#        cc N [args...]  - launches directly with Account N
#        cc add [name]   - add a new account

PROFILES_DIR="$HOME/.claude-profiles"
PICKER="$PROFILES_DIR/picker.mjs"
CONFIG="$PROFILES_DIR/config.json"

# ── cc add [name] — add a new account ────────────────────────
if [[ "$1" == "add" ]]; then
    shift
    CUSTOM_NAME="$*"

    # Find next account number
    NEXT=$(node -e "
        const fs = require('fs');
        let c = { accounts: {} };
        try { c = JSON.parse(fs.readFileSync('$CONFIG','utf8')); } catch {}
        const keys = Object.keys(c.accounts).map(Number).filter(n => !isNaN(n));
        console.log(Math.max(...keys, 0) + 1);
    " 2>/dev/null)

    if [[ -z "$NEXT" ]]; then
        echo "  Error: could not determine next account number."
        exit 1
    fi

    DIR_NAME="account$NEXT"
    ACCT_DIR="$PROFILES_DIR/$DIR_NAME"

    # Prompt for name if not provided
    if [[ -z "$CUSTOM_NAME" ]]; then
        read -rp "  Account name [Account $NEXT]: " CUSTOM_NAME
        [[ -z "$CUSTOM_NAME" ]] && CUSTOM_NAME="Account $NEXT"
    fi

    # Create directory and settings
    mkdir -p "$ACCT_DIR"

    # Add to config.json
    node -e "
        const fs = require('fs');
        let c = { accounts: {} };
        try { c = JSON.parse(fs.readFileSync('$CONFIG','utf8')); } catch {}
        c.accounts['$NEXT'] = { name: '$CUSTOM_NAME', configDir: '$DIR_NAME' };
        fs.writeFileSync('$CONFIG', JSON.stringify(c, null, 2) + '\n');
    " 2>/dev/null

    # Create settings.json with statusline
    node -e "
        const fs = require('fs');
        const h = require('os').homedir().replace(/\\\\/g, '/');
        const s = { statusLine: { type: 'command', command: 'node ' + h + '/.claude-profiles/statusline.js' } };
        fs.writeFileSync('$ACCT_DIR/settings.json', JSON.stringify(s, null, 2) + '\n');
    " 2>/dev/null

    echo ""
    echo "  Account $NEXT added!"
    echo ""
    echo "  Name:      $CUSTOM_NAME"
    echo "  Directory:  $ACCT_DIR"
    echo ""
    echo "  Run 'cc $NEXT' to log in and start using it."
    echo ""
    exit 0
fi

# ── cc <number> — quick-switch ────────────────────────────────
if [[ "$1" =~ ^-?[0-9]+$ ]]; then
    ACCT="${1#-}"
    shift

    if [[ "$ACCT" == "1" ]]; then
        unset CLAUDE_CONFIG_DIR
        exec claude "$@"
    fi

    # Look up configDir from config.json
    if [[ -f "$CONFIG" ]] && command -v node &>/dev/null; then
        DIR=$(node -e "
            try {
                const c = JSON.parse(require('fs').readFileSync('$CONFIG','utf8'));
                const a = c.accounts['$ACCT'];
                if (a && a.configDir) process.stdout.write(a.configDir);
                else if (a) process.stdout.write('__DEFAULT__');
            } catch {}
        " 2>/dev/null)

        if [[ -n "$DIR" && "$DIR" != "__DEFAULT__" ]]; then
            export CLAUDE_CONFIG_DIR="$PROFILES_DIR/$DIR"
            exec claude "$@"
        elif [[ "$DIR" == "__DEFAULT__" ]]; then
            unset CLAUDE_CONFIG_DIR
            exec claude "$@"
        fi
    fi

    # Fallback: assume accountN directory
    export CLAUDE_CONFIG_DIR="$PROFILES_DIR/account$ACCT"
    exec claude "$@"
fi

# ── cc — interactive picker ───────────────────────────────────
profile_path=$(node "$PICKER")

if [[ -z "$profile_path" ]]; then
    exit 0
fi

if [[ "$profile_path" == "__DEFAULT__" ]]; then
    unset CLAUDE_CONFIG_DIR
else
    export CLAUDE_CONFIG_DIR="$profile_path"
fi

exec claude "$@"
